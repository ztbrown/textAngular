/*
 textAngular
 Author : Austin Anderson
 License : 2013 MIT
 Version 1.2.0

 See README.md or https://github.com/fraywing/textAngular/wiki for requirements and use.
 */(function(){"Use Strict";function n(e,n){if(!e||e===""||t.hasOwnProperty(e))throw"textAngular Error: A unique name is required for a Tool Definition";if(n.display&&(n.display===""||angular.element(n.display).length===0)||!n.display&&!n.buttontext&&!n.iconclass)throw'textAngular Error: Tool Definition for "'+e+'" does not have a valid display/iconclass/buttontext value';t[e]=n}var e=angular.module("textAngular",["ngSanitize"]);e.value("taOptions",{toolbar:[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight"],["html","insertImage","insertLink","unlink"]],classes:{focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"}});var t={};e.constant("taRegisterTool",n),e.value("taTools",t),e.config(["taRegisterTool",function(e){angular.forEach(t,function(e,n){delete t[n]}),e("html",{buttontext:"Toggle HTML",action:function(){this.$editor().switchView()},activeState:function(){return this.$editor().showHtml}});var n=function(e){return function(){return this.$editor().queryFormatBlockState(e)}},r=function(){return this.$editor().wrapSelection("formatBlock","<"+this.name.toUpperCase()+">")};angular.forEach(["h1","h2","h3","h4","h5","h6"],function(t){e(t.toLowerCase(),{buttontext:t.toUpperCase(),action:r,activeState:n(t.toLowerCase())})}),e("p",{buttontext:"P",action:function(){return this.$editor().wrapSelection("formatBlock","<P>")},activeState:function(){return this.$editor().queryFormatBlockState("p")}}),e("pre",{buttontext:"pre",action:function(){return this.$editor().wrapSelection("formatBlock","<PRE>")},activeState:function(){return this.$editor().queryFormatBlockState("pre")}}),e("ul",{iconclass:"fa fa-list-ul",action:function(){return this.$editor().wrapSelection("insertUnorderedList",null)},activeState:function(){return document.queryCommandState("insertUnorderedList")}}),e("ol",{iconclass:"fa fa-list-ol",action:function(){return this.$editor().wrapSelection("insertOrderedList",null)},activeState:function(){return document.queryCommandState("insertOrderedList")}}),e("quote",{iconclass:"fa fa-quote-right",action:function(){return this.$editor().wrapSelection("formatBlock","<BLOCKQUOTE>")},activeState:function(){return this.$editor().queryFormatBlockState("blockquote")}}),e("undo",{iconclass:"fa fa-undo",action:function(){return this.$editor().wrapSelection("undo",null)}}),e("redo",{iconclass:"fa fa-repeat",action:function(){return this.$editor().wrapSelection("redo",null)}}),e("bold",{iconclass:"fa fa-bold",action:function(){return this.$editor().wrapSelection("bold",null)},activeState:function(){return document.queryCommandState("bold")},commandKeyCode:98}),e("justifyLeft",{iconclass:"fa fa-align-left",action:function(){return this.$editor().wrapSelection("justifyLeft",null)},activeState:function(e){var t=!1;return e&&(t=e.css("text-align")==="left"||e.css("text-align")===""),t=t||document.queryCommandState("justifyLeft"),t}}),e("justifyRight",{iconclass:"fa fa-align-right",action:function(){return this.$editor().wrapSelection("justifyRight",null)},activeState:function(e){var t=!1;return e&&(t=e.css("text-align")==="right"),t=t||document.queryCommandState("justifyRight"),t}}),e("justifyCenter",{iconclass:"fa fa-align-center",action:function(){return this.$editor().wrapSelection("justifyCenter",null)},activeState:function(e){var t=!1;return e&&(t=e.css("text-align")==="center"),t=t||document.queryCommandState("justifyCenter"),t}}),e("italics",{iconclass:"fa fa-italic",action:function(){return this.$editor().wrapSelection("italic",null)},activeState:function(){return document.queryCommandState("italic")},commandKeyCode:105}),e("underline",{iconclass:"fa fa-underline",action:function(){return this.$editor().wrapSelection("underline",null)},activeState:function(){return document.queryCommandState("underline")},commandKeyCode:117}),e("clear",{iconclass:"fa fa-ban",action:function(){return this.$editor().wrapSelection("removeFormat",null)}}),e("insertImage",{iconclass:"fa fa-picture-o",action:function(){var e;e=prompt("Please enter an image URL to insert","http://");if(e!==""&&e!=="http://")return this.$editor().wrapSelection("insertImage",e)}}),e("insertLink",{iconclass:"fa fa-link",action:function(){var e;e=prompt("Please enter an URL to insert","http://");if(e!==""&&e!=="http://")return this.$editor().wrapSelection("createLink",e)},activeState:function(e){return e?e[0].tagName==="A":!1}}),e("unlink",{iconclass:"fa fa-unlink",action:function(){return this.$editor().wrapSelection("unlink",null)},activeState:function(e){return e?e[0].tagName==="A":!1}})}]),e.directive("textAngular",["$compile","$timeout","$log","taOptions","taSanitize","textAngularManager",function(e,t,n,r,i,s){return n.info("Thank you for using textAngular! http://www.textangular.com"),{require:"?ngModel",scope:{},restrict:"EA",link:function(n,i,o,u){var a,f,l,c,h,p,d,v,m=Math.floor(Math.random()*1e16),g=o.name?o.name:"textAngularEditor"+m;angular.extend(n,angular.copy(r),{wrapSelection:function(e,t){document.execCommand(e,!1,t),n.displayElements.text[0].focus()},showHtml:!1}),o.taFocussedClass&&(n.classes.focussed=o.taFocussedClass),o.taTextEditorClass&&(n.classes.textEditor=o.taTextEditorClass),o.taHtmlEditorClass&&(n.classes.htmlEditor=o.taHtmlEditorClass),d=i.html(),i.html(""),n.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea id='taHtmlElement' ng-show='showHtml' ta-bind ng-model='html'></textarea>"),text:angular.element("<div id='taTextElement' contentEditable='true' ng-hide='showHtml' ta-bind ng-model='html'></div>")},i.append(n.displayElements.text),i.append(n.displayElements.html),n.displayElements.forminput.attr("name",g),i.append(n.displayElements.forminput),o.tabindex&&(n.displayElements.text.attr("tabindex",o.tabindex),n.displayElements.html.attr("tabindex",o.tabindex)),!o.placeholder||(n.displayElements.text.attr("placeholder",o.placeholder),n.displayElements.html.attr("placeholder",o.placeholder)),o.taDisabled&&(n.displayElements.text.attr("ta-readonly","disabled"),n.displayElements.html.attr("ta-readonly","disabled"),n.disabled=n.$parent.$eval(o.taDisabled),n.$parent.$watch(o.taDisabled,function(e){n.disabled=e,n.disabled?i.addClass(n.classes.disabled):i.removeClass(n.classes.disabled)})),e(n.displayElements.text)(n),e(n.displayElements.html)(n),i.addClass("ta-root"),n.displayElements.text.addClass("ta-text ta-editor "+n.classes.textEditor),n.displayElements.html.addClass("ta-html ta-editor "+n.classes.textEditor),n._actionRunning=!1;var y=!1;n.startAction=function(){n._actionRunning=!0;if(window.rangy&&window.rangy.saveSelection)return y=window.rangy.saveSelection(),function(){window.rangy.restoreSelection(y)}},n.endAction=function(){n._actionRunning=!1,y&&rangy.removeMarkers(y),y=!1,n.updateSelectedStyles(),n.showHtml||n.updateTaBindtaTextElement()},h=function(){i.addClass(n.classes.focussed),v.focus()},n.displayElements.html.on("focus",h),n.displayElements.text.on("focus",h),p=function(e){return t(function(){document.activeElement!==n.displayElements.html[0]&&document.activeElement!==n.displayElements.text[0]&&(i.removeClass(n.classes.focussed),n._actionRunning||v.unfocus(),t(function(){i.triggerHandler("blur")},0))},100),e.preventDefault(),!1},n.displayElements.html.on("blur",p),n.displayElements.text.on("blur",p),n.queryFormatBlockState=function(e){e=e.toLowerCase();var t=document.queryCommandValue("formatBlock").toLowerCase();return t===e||t===e},n.switchView=function(){n.showHtml=!n.showHtml,n.showHtml?t(function(){return n.displayElements.html[0].focus()},100):t(function(){return n.displayElements.text[0].focus()},100)};if(o.ngModel){var b=!0;u.$render=function(){if(b){b=!1;var e=n.$parent.$eval(o.ngModel);(e===undefined||e===null)&&d&&d!==""&&u.$setViewValue(d)}n.displayElements.forminput.val(u.$viewValue),document.activeElement!==n.displayElements.html[0]&&document.activeElement!==n.displayElements.text[0]&&(n.html=u.$viewValue||"")}}else n.displayElements.forminput.val(d),n.html=d;n.$watch("html",function(e,t){e!==t&&(o.ngModel&&u.$setViewValue(e),n.displayElements.forminput.val(e))});if(o.taTargetToolbars)v=s.registerEditor(g,n,o.taTargetToolbars.split(","));else{var w=angular.element('<div text-angular-toolbar name="textAngularToolbar'+m+'">');o.taToolbar&&w.attr("ta-toolbar",o.taToolbar),o.taToolbarClass&&w.attr("ta-toolbar-class",o.taToolbarClass),o.taToolbarGroupClass&&w.attr("ta-toolbar-group-class",o.taToolbarGroupClass),o.taToolbarButtonClass&&w.attr("ta-toolbar-button-class",o.taToolbarButtonClass),o.taToolbarActiveButtonClass&&w.attr("ta-toolbar-active-button-class",o.taToolbarActiveButtonClass),o.taFocussedClass&&w.attr("ta-focussed-class",o.taFocussedClass),i.prepend(w),e(w)(n.$parent),v=s.registerEditor(g,n,["textAngularToolbar"+m])}n.$on("$destroy",function(){s.unregisterEditor(g)}),n._bUpdateSelectedStyles=!1,n.updateSelectedStyles=function(){var e;window.rangy&&window.rangy.getSelection&&(e=window.rangy.getSelection().getAllRanges()).length===1?v.updateSelectedStyles(angular.element(e[0].commonAncestorContainer.parentNode)):v.updateSelectedStyles(),n._bUpdateSelectedStyles&&t(n.updateSelectedStyles,200)},a=function(){n._bUpdateSelectedStyles||(n._bUpdateSelectedStyles=!0,n.$apply(function(){n.updateSelectedStyles()}))},n.displayElements.html.on("keydown",a),n.displayElements.text.on("keydown",a),f=function(){n._bUpdateSelectedStyles=!1},n.displayElements.html.on("keyup",f),n.displayElements.text.on("keyup",f),l=function(e){if(v.sendKeyCommand(e))return n._bUpdateSelectedStyles||n.$apply(function(){n.updateSelectedStyles()}),e.preventDefault(),!1},n.displayElements.html.on("keypress",l),n.displayElements.text.on("keypress",l),c=function(){n._bUpdateSelectedStyles=!1,n.$apply(function(){n.updateSelectedStyles()})},n.displayElements.html.on("mouseup",c),n.displayElements.text.on("mouseup",c)}}}]).directive("taBind",["taSanitize","$timeout",function(e,t){return{require:"ngModel",scope:{},link:function(n,r,i,s){var o=r.attr("contenteditable")!==undefined&&r.attr("contenteditable"),u=o||r[0].tagName.toLowerCase()==="textarea"||r[0].tagName.toLowerCase()==="input",a=!1,f=function(){if(o)return r.html();if(u)return r.val();throw"textAngular Error: attempting to update non-editable taBind"};n.$parent["updateTaBind"+(i.id||"")]=function(){a||s.$setViewValue(f())},u&&(r.on("keyup",function(){a||s.$setViewValue(f())}),r.on("paste cut",function(){a||t(function(){s.$setViewValue(f())},0)})),u&&!o&&r.on("change blur",function(){a||s.$setViewValue(f())}),_focusin=function(){r.text()===r.attr("placeholder")&&r.hasClass("placeholder-text")&&(r.removeClass("placeholder-text"),r.text(""))},_focusout=function(){r.attr("placeholder")&&r.text()===""&&(r.text(i.placeholder),r.addClass("placeholder-text"))},r.attr("placeholder")&&(r.html(r.attr("placeholder")),r.addClass("placeholder-text"),r.on("focus",_focusin),r.on("blur",_focusout));var l=function(t){return s.$oldViewValue=e(t,s.$oldViewValue)};s.$parsers.push(l),s.$formatters.push(l),s.$render=function(){if(document.activeElement!==r[0]){var e=s.$viewValue||"";o?(e===""&&r.attr("placeholder")?(r.html(r.attr("placeholder")),r.addClass("placeholder-text")):(r.html(e),r.removeClass("placeholder-text")),a||r.find("a").on("click",function(e){return e.preventDefault(),!1})):r[0].tagName.toLowerCase()!=="textarea"&&r[0].tagName.toLowerCase()!=="input"?r.html(e):r.val(e)}},i.taReadonly&&(a=n.$parent.$eval(i.taReadonly),a?((r[0].tagName.toLowerCase()==="textarea"||r[0].tagName.toLowerCase()==="input")&&r.attr("disabled","disabled"),r.attr("contenteditable")!==undefined&&r.attr("contenteditable")&&r.removeAttr("contenteditable")):r[0].tagName.toLowerCase()==="textarea"||r[0].tagName.toLowerCase()==="input"?r.removeAttr("disabled"):o&&r.attr("contenteditable","true"),n.$parent.$watch(i.taReadonly,function(e,t){if(t===e)return;e?((r[0].tagName.toLowerCase()==="textarea"||r[0].tagName.toLowerCase()==="input")&&r.attr("disabled","disabled"),r.attr("contenteditable")!==undefined&&r.attr("contenteditable")&&r.removeAttr("contenteditable")):r[0].tagName.toLowerCase()==="textarea"||r[0].tagName.toLowerCase()==="input"?r.removeAttr("disabled"):o&&r.attr("contenteditable","true"),a=e}))}}}]).factory("taSanitize",["$sanitize",function(t){function n(e,t){var r=[],i=e.children();return i.length&&angular.forEach(i,function(e){r=r.concat(n(angular.element(e),t))}),e.attr(t)&&r.push(e),r}return function(r,i){var s=angular.element("<div>"+r+"</div>");angular.forEach(n(s,"align"),function(e){e.css("text-align",e.attr("align")),e.removeAttr("align")}),r=s.html();var o;try{o=t(r)}catch(u){o=i||""}return o}}]).directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction",function(e,t,n,r,i){return{scope:{name:"@"},restrict:"EA",link:function(s,o,u){if(!s.name||s.name==="")throw"textAngular Error: A toolbar requires a name";angular.extend(s,angular.copy(n)),u.taToolbar&&(s.toolbar=s.$parent.$eval(u.taToolbar)),u.taToolbarClass&&(s.classes.toolbar=u.taToolbarClass),u.taToolbarGroupClass&&(s.classes.toolbarGroup=u.taToolbarGroupClass),u.taToolbarButtonClass&&(s.classes.toolbarButton=u.taToolbarButtonClass),u.taToolbarActiveButtonClass&&(s.classes.toolbarButtonActive=u.taToolbarActiveButtonClass),u.taFocussedClass&&(s.classes.focussed=u.taFocussedClass),s.disabled=!0,s.focussed=!1,o.html(""),o.addClass("ta-toolbar "+s.classes.toolbar),s.$watch("focussed",function(){s.focussed?o.addClass(s.classes.focussed):o.removeClass(s.classes.focussed)}),setupToolElement=function(t,n){var r;t&&t.display?(r=angular.element(t.display),n._display=t.display):n._display?r=angular.element(n._display):r=angular.element("<button type='button'>"),r.addClass(s.classes.toolbarButton),r.attr("name",n.name),r.attr("unselectable","on"),r.attr("ng-disabled","isDisabled()"),r.attr("tabindex","-1"),r.attr("ng-click","executeAction()"),r.attr("ng-class","displayActiveToolClass(active)"),r.on("mousedown",function(e){return e.preventDefault(),!1});if(t&&!t.display&&!n._display){r.html(""),t.buttontext&&r.html(t.buttontext);if(t.iconclass){var i=angular.element("<i>"),o=r.html();i.addClass(t.iconclass),r.html(""),r.append(i),o&&o!==""&&r.append("&nbsp;"+o)}}return e(r)(n)},s.tools={},s._parent={disabled:!0,showHtml:!1,queryFormatBlockState:function(){return!1}};var a={$editor:function(){return s._parent},isDisabled:function(){return this.$eval("disabled")||this.$eval("disabled()")||this.name!=="html"&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled},displayActiveToolClass:function(e){return e?s.classes.toolbarButtonActive:""},executeAction:i};angular.forEach(s.toolbar,function(e){groupElement=angular.element("<div>"),groupElement.addClass(s.classes.toolbarGroup),angular.forEach(e,function(e){var t=angular.extend(s.$new(!0),r[e],a,{name:e});s.tools[e]=t,s.tools[e].$element=setupToolElement(r[e],t),groupElement.append(s.tools[e].$element)}),o.append(groupElement)}),s.updateToolDisplay=function(e,t){var n=r[e],i=s.tools[e];i&&(t.buttontext===null?delete t.buttontext:!t.buttontext&&n.buttontext&&(t.buttontext=n.buttontext),t.iconclass===null?delete t.iconclass:!t.iconclass&&n.iconclass&&(t.iconclass=n.iconclass),t.display===null?(delete t.display,delete i._display):!i._display&&n.display&&(t.display=n.display),toolElement=setupToolElement(t,i),i.$element.replaceWith(toolElement),i.$element=toolElement)},t.registerToolbar(s),s.$on("$destroy",function(){t.unregisterToolbar(s.name)})}}}]).service("taToolExecuteAction",["$q",function(e){return function(t){!this.$editor&&t&&(this.$editor=function(){return t});var n=e.defer(),r=n.promise;r["finally"](this.$editor().endAction);var i;try{i=this.action(n,this.$editor().startAction())}catch(s){}(i||i===undefined)&&n.resolve()}}]).service("textAngularManager",["taToolExecuteAction",function(e){var n={},r={};return{registerEditor:function(i,s,o){if(!i||i==="")throw"textAngular Error: An editor requires a name";if(!s)throw"textAngular Error: An editor requires a scope";if(r[i])throw'textAngular Error: An Editor with name "'+i+'" already exists';var u=[];return angular.forEach(o,function(e){n[e]&&u.push(n[e])}),r[i]={scope:s,toolbars:o,_registerToolbar:function(e){this.toolbars.indexOf(e.name)>=0&&u.push(e)}},{disable:function(){angular.forEach(u,function(e){e.disabled=!0})},enable:function(){angular.forEach(u,function(e){e.disabled=!1})},focus:function(){angular.forEach(u,function(e){e._parent=s,e.disabled=!1,e.focussed=!0})},unfocus:function(){angular.forEach(u,function(e){e.disabled=!0,e.focussed=!1})},updateSelectedStyles:function(e){angular.forEach(u,function(t){angular.forEach(t.tools,function(t){t.activeState&&(t.active=t.activeState(e))})})},sendKeyCommand:function(n){var r=!1;return(n.ctrlKey||n.metaKey)&&angular.forEach(t,function(t){t.commandKeyCode&&t.commandKeyCode===n.which&&(e.call(t,s),r=!0)}),r}}},retrieveEditor:function(e){return r[e]},unregisterEditor:function(e){delete r[e]},registerToolbar:function(e){if(!e)throw"textAngular Error: A toolbar requires a scope";if(!e.name||e.name==="")throw"textAngular Error: A toolbar requires a name";if(n[e.name])throw'textAngular Error: A toolbar with name "'+e.name+'" already exists';n[e.name]=e,angular.forEach(r,function(t){t._registerToolbar(e)})},retrieveToolbar:function(e){return n[e]},retrieveToolbarsViaEditor:function(e){var t=[],n=this;return angular.forEach(this.retrieveEditor(e).toolbars,function(e){t.push(n.retrieveToolbar(e))}),t},unregisterToolbar:function(e){delete n[e]},updateToolsDisplay:function(e){var t=this;angular.forEach(e,function(e,n){t.updateToolDisplay(n,e)})},resetToolsDisplay:function(){var e=this;angular.forEach(t,function(t,n){e.resetToolDisplay(n)})},updateToolDisplay:function(e,t){var r=this;angular.forEach(n,function(n,i){r.updateToolbarToolDisplay(i,e,t)})},resetToolDisplay:function(e){var t=this;angular.forEach(n,function(n,r){t.resetToolbarToolDisplay(r,e)})},updateToolbarToolDisplay:function(e,t,r){n[e]&&n[e].updateToolDisplay(t,r)},resetToolbarToolDisplay:function(e,r){n[e]&&n[e].updateToolDisplay(r,t[r])},refreshEditor:function(e){if(!r[e])throw'textAngular Error: No Editor with name "'+e+'" exists';r[e].scope.updateTaBindtaTextElement(),r[e].scope.$$phase||r[e].scope.$digest()}}}])})();